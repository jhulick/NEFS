<?xml version="1.0" encoding="utf-8"?>

<project default="generate-all">

    <target name=".init-app-path" unless="app.path" description="If app.path property is not passed in, set the application path relative to the location of the build project file.">
        <path id="app.home.path">
            <pathelement location="${basedir}/../../"/>
        </path>
        <pathconvert targetos="unix" property="app.path" refid="app.home.path"/>
    </target>

    <target name=".init" depends=".init-app-path" description="Private target that performs intialization for all tasks. This target is designed for use as a dependent, not to be called directly.">
        <taskdef name="sparx" classname="com.netspective.sparx.ant.SparxTask"/>

        <property name="app.WEB-INF.path" value="${app.path}/WEB-INF"/>
        <property name="app.WEB-INF.classes.path" value="${app.WEB-INF.path}/classes"/>
        <property name="app.database.path" value="${app.WEB-INF.path}/database"/>

        <property name="sparx.resources.path" value="${app.path}/sparx"/>
        <property name="sparx.project.path" value="${app.WEB-INF.path}/sparx"/>
        <property name="sparx.project.file" value="${sparx.project.path}/project.xml"/>

        <sparx action="get-default-schema-name" projectFile="${sparx.project.file}" property="app.database.schema.default-name"/>

        <echo message="      App HOME is '${app.path}'"/>
        <echo message="  Classes HOME is '${app.WEB-INF.classes.path}'"/>
        <echo message="Default Schema is '${app.database.schema.default-name}'"/>
    </target>

    <target name="generate-id-constants" depends=".init" description="Generates typed Java constants for all dialog, field, query, and schema identifiers in Sparx XML files. Instead of accessing identifiers by strings programmers can access the identifiers using Java constants.">
        <sparx action="generate-id-constants"
               projectFile="${sparx.project.file}"
               destDir="${app.WEB-INF.classes.path}"
               idConstantsClass="app.id"/>
    </target>

    <target name="generate-ddl" depends=".init" description="Generates all database-specific SQL Data Definition Language (DDL) files for the default schema. This target should be executed anytime the default schema is modified but instead of using the create-database you want to only generate DDL.">
        <sparx action="generate-ddl"
               projectFile="${sparx.project.file}"
               destDir="${app.database.path}/ddl"
               ddl="*"/>
    </target>

    <target name="generate-dal" depends=".init" description="Generates typed Java classes for all tables and columns in the default database schema. This target should be executed anytime the default schema is modified.">
        <sparx action="generate-dal"
               projectFile="${sparx.project.file}"
               destDir="${app.WEB-INF.classes.path}"
               dalPackage="app.dal"/>
    </target>

    <target name="generate-import-data-dtd" depends=".init" description="Generates a DTD that describes the XML import structure for the default database schema. This target should be executed anytime the default schema is modified.">
        <sparx action="generate-import-data-dtd"
               projectFile="${sparx.project.file}"
               dtdFile="${app.database.path}/data/${app.database.schema.default-name}-import.dtd"/>
    </target>

    <target name="generate-graphviz-erd" depends=".init" description="Generates a DOT file used by GraphViz to produce entity-relationship diagrams (ERDs) for the default schema.">
        <sparx action="generate-graphviz-erd"
               projectFile="${sparx.project.file}"
               graphVizDot="${app.database.path}/data/${app.database.schema.default-name}-erd.dot"/>
    </target>

    <target name="generate-all" depends="generate-id-constants,generate-ddl,generate-dal,generate-import-data-dtd,generate-graphviz-erd" description="Generates everything."/>

    <target name="create-database-hsqldb" depends="generate-dal,generate-import-data-dtd,generate-graphviz-erd" description="Erases the existing default datasource (Hypersonic database), generates the SQL DDL for the default schema, loads the SQL DDL (effectively creating the Hypersonic SQL database), and finally loads the 'starter' from XML files using Sparx import from XML feature. This target should be executed anytime the default schema is modified.">
        <property name="app.database.instance.path" value="${app.database.path}/instance"/>
        <property name="jdbc.driver" value="org.hsqldb.jdbcDriver"/>
        <property name="jdbc.url" value="jdbc:hsqldb:${app.database.instance.path}/${app.database.schema.default-name}"/>
        <property name="jdbc.userid" value="sa"/>
        <property name="jdbc.password" value=""/>

        <!-- recreate the Hypersonic database by deleting existing files and making sure the database directory exists -->
        <mkdir dir="${app.database.instance.path}"/>
        <delete>
            <fileset dir="${app.database.instance.path}" includes="${app.database.schema.default-name}*"/>
        </delete>

        <echo message="Hypersonic database name is '${app.database.schema.default-name}' and will be stored in ${app.database.instance.path}"/>

        <!-- generate the Hypersonic DDL -->
        <sparx action="generate-ddl"
               projectFile="${sparx.project.file}"
               destDir="${app.database.path}/ddl"
               ddl="/^hsqldb/"/>
        <property name="app.database.schema.ddl.loader.file"
                  value="${app.database.path}/ddl/${app.database.schema.default-name}-hsqldb.sql"/>

        <!-- load the Hypersonic DDL -->
        <sql src="${app.database.schema.ddl.loader.file}"
             driver="${jdbc.driver}" url="${jdbc.url}" userid="${jdbc.userid}" password=""/>

        <!-- import the "starter" data into the Hypersonic database -->
        <sparx action="import-data"
               projectFile="${sparx.project.file}"
               import="${app.database.path}/data/initial-and-test-data.xml"
               driver="${jdbc.driver}" url="${jdbc.url}" userid="${jdbc.userid}" password="" />
    </target>

</project>